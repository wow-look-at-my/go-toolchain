name: 'Go Safe Build'
description: 'Build Go projects with coverage enforcement - fails if coverage is below threshold'
author: 'go-safe-build'

branding:
  icon: 'check-circle'
  color: 'green'

inputs:
  min-coverage:
    description: 'Minimum coverage percentage required (0 = test only, no build)'
    required: false
    default: '80'
  output:
    description: 'Output binary name (default: directory name)'
    required: false
    default: ''
  cov-detail:
    description: 'Show detailed coverage: "func" or "file"'
    required: false
    default: ''
  json:
    description: 'Output coverage report as JSON'
    required: false
    default: 'false'
  verbose:
    description: 'Show test output line by line'
    required: false
    default: 'false'
  working-directory:
    description: 'Working directory for the build'
    required: false
    default: '.'
  source:
    description: 'How to obtain go-safe-build: "release" downloads a pre-built binary, "source" clones and builds from source via go run'
    required: false
    default: 'release'

outputs:
  coverage:
    description: 'Total coverage percentage'
  binary:
    description: 'Path to the built binary'

runs:
  using: 'composite'
  steps:
    - name: Install go-safe-build from release
      if: inputs.source == 'release'
      shell: bash
      run: |
        set -euo pipefail
        OS="$(uname -s | tr '[:upper:]' '[:lower:]')"
        ARCH="$(uname -m)"
        case "$ARCH" in
          x86_64)  ARCH=amd64 ;;
          aarch64) ARCH=arm64 ;;
        esac
        TAG="${{ github.action_ref }}"
        URL="https://github.com/PazerOP/go-safe-build/releases/download/${TAG}/go-safe-build-${OS}-${ARCH}"
        curl -fsSL -o /usr/local/bin/go-safe-build "$URL"
        chmod +x /usr/local/bin/go-safe-build

    - name: Set up Go
      if: inputs.source == 'source'
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'

    - name: Install go-safe-build from source
      if: inputs.source == 'source'
      shell: bash
      run: |
        set -euo pipefail
        TAG="${{ github.action_ref }}"
        CLONE_DIR="$(mktemp -d)"
        git clone --depth 1 --branch "$TAG" https://github.com/PazerOP/go-safe-build.git "$CLONE_DIR"
        go build -o /usr/local/bin/go-safe-build "$CLONE_DIR/src"
        rm -rf "$CLONE_DIR"

    - name: Run go-safe-build
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        set -euo pipefail
        ARGS="--min-coverage ${{ inputs.min-coverage }}"
        if [ -n "${{ inputs.output }}" ]; then
          ARGS="$ARGS -o ${{ inputs.output }}"
        fi
        if [ -n "${{ inputs.cov-detail }}" ]; then
          ARGS="$ARGS --cov-detail ${{ inputs.cov-detail }}"
        fi
        if [ "${{ inputs.json }}" = "true" ]; then
          ARGS="$ARGS --json"
        fi
        if [ "${{ inputs.verbose }}" = "true" ]; then
          ARGS="$ARGS --verbose"
        fi
        go-safe-build $ARGS
