name: CI

on:
  push:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure git for private repos
        run: git config --global url."https://${{ secrets.PRIVATE_ORG_REPO_READ }}@github.com/wow-look-at-my/".insteadOf "https://github.com/wow-look-at-my/"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Build and test
        run: go run ./src

      - name: Install bats and attr
        run: |
          sudo apt-get update
          sudo apt-get install -y bats jq attr

      - name: Run integration tests
        run: bats tests/

  gha-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure git for private repos
        run: git config --global url."https://${{ secrets.PRIVATE_ORG_REPO_READ }}@github.com/wow-look-at-my/".insteadOf "https://github.com/wow-look-at-my/"

      - name: Build and test with action
        uses: ./

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: go-toolchain-binaries
          path: build/go-toolchain_*
